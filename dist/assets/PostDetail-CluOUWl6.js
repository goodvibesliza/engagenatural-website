const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DYXKkgZj.js","assets/index-DC-vH16-.css"])))=>i.map(i=>d[i]);
import{u as z,a as K,r as x,b as X,j as e,C as k,p as Z,W as ee,P as te,d as v,c as m,g as A,e as se,q as $,f as N,w as O,h as W,o as ne,i as ie,k as ae,_ as D,l as re}from"./index-DYXKkgZj.js";function le(){const{postId:u}=z(),C=K(),S=x.useRef(null),[T,R]=x.useState(!0),[r,E]=x.useState(null),[P,g]=x.useState([]),[j,y]=x.useState(!1),[I,f]=x.useState([]),[L,G]=x.useState(""),[U,M]=x.useState(""),{user:o}=X();x.useEffect(()=>{!T&&r&&S.current&&S.current.focus()},[T,r]),x.useEffect(()=>{let t=!1;async function i(){R(!0);try{let s=null,n="unknown";const a=ee.find(c=>c.id===u),l=a?null:te.find(c=>c.id===u),d=a||l||null;if(d)s={id:d.id,brand:d.brand||"General",title:d.title||"Update",snippet:d.snippet||d.content||"",content:d.content||d.snippet||"",createdAt:d.createdAt||null,timeAgo:d.timeAgo||"",trainingId:d.trainingId||null,likeIds:[],commentIds:[]},n=a?"whatsGood":"pro";else{const c=v(m,"community_posts",u),b=await A(c);if(b.exists()){const h=b.data();s={id:b.id,brand:h.brand||h.communityName||"General",title:h.title||"Update",snippet:h.body||"",content:h.body||"",createdAt:h.createdAt||null,trainingId:h.trainingId||null,likeIds:[],commentIds:[]},n="unknown"}}if(s&&!t)E(s),se({postId:s.id,feedType:n});else if(!t){E(null),R(!1);return}if(m&&!t)try{const c=$(N(m,"post_likes"),O("postId","==",u)),b=$(N(m,"community_comments"),O("postId","==",u)),[h,oe]=await Promise.all([W(c),W(b)]);if(!t){const p=h.data().count||0;g(Array.from({length:p},(_,w)=>`x${w}`))}const Y=$(N(m,"community_comments"),O("postId","==",u),ne("createdAt","asc")),H=await ie(Y);t||f(H.docs.map(p=>({id:p.id,status:"ok",...p.data()})));try{if(o!=null&&o.uid){const p=v(m,"post_likes",`${u}_${o.uid}`),_=await A(p);t||(y(_.exists()),g(w=>{const V=w.includes("me");return _.exists()&&!V?[...w,"me"]:!_.exists()&&V?w.filter(J=>J!=="me"):w}))}}catch(p){console.warn("Failed to check if user liked post:",p)}}catch(c){console.warn("Failed to load comments/likes from Firestore:",c),t||(g([]),f([]),y(!1))}}catch{t||E(null)}finally{t||R(!1)}}return i(),()=>{t=!0}},[u]),x.useEffect(()=>{let t=!1;async function i(){if(u){if(!(o!=null&&o.uid)){y(!1),g(s=>s.includes("me")?s.filter(n=>n!=="me"):s);return}try{const s=v(m,"post_likes",`${u}_${o.uid}`),n=await A(s);if(t)return;y(n.exists()),g(a=>{const l=a.includes("me");return n.exists()&&!l?[...a,"me"]:!n.exists()&&l?a.filter(d=>d!=="me"):a})}catch{}}}return i(),()=>{t=!0}},[o==null?void 0:o.uid,u]);const F=async()=>{if(!r)return;M("");const t=!j;y(i=>{const s=!i;return ae({postId:r.id,liked:s}),s}),g(i=>{const s=i.includes("me");return t?s?i:[...i,"me"]:s?i.filter(n=>n!=="me"):i});try{if(m&&(o!=null&&o.uid)){const i=v(m,"post_likes",`${r.id}_${o.uid}`);if((await A(i)).exists()){if(!t){const{deleteDoc:n}=await D(async()=>{const{deleteDoc:a}=await import("./index-DYXKkgZj.js").then(l=>l.m);return{deleteDoc:a}},__vite__mapDeps([0,1]));await n(i)}}else if(t){const{setDoc:n,serverTimestamp:a}=await D(async()=>{const{setDoc:l,serverTimestamp:d}=await import("./index-DYXKkgZj.js").then(c=>c.m);return{setDoc:l,serverTimestamp:d}},__vite__mapDeps([0,1]));await n(i,{postId:r.id,userId:o.uid,createdAt:a()})}}}catch{y(s=>!s),g(s=>{const n=s.includes("me");return t?n?s.filter(a=>a!=="me"):s:n?s:[...s,"me"]}),M(k.errors.generic)}},Q=async()=>{const t=L.trim();if(!t)return;re({postId:r.id,length:t.length});const i=new Date,s={id:`local-${i.getTime()}`,text:t,createdAt:i,userRole:"you",status:"pending"};if(f(n=>[...n,s]),G(""),!m||!(o!=null&&o.uid)){f(n=>n.map(a=>a.id===s.id?{...a,status:"ok"}:a));return}try{const{addDoc:n,serverTimestamp:a}=await D(async()=>{const{addDoc:d,serverTimestamp:c}=await import("./index-DYXKkgZj.js").then(b=>b.m);return{addDoc:d,serverTimestamp:c}},__vite__mapDeps([0,1])),l=await n(N(m,"community_comments"),{postId:r.id,communityId:r.communityId||"whats-good",brandId:r.brandId||null,userId:o.uid,userRole:o.role||"user",text:t,createdAt:a()});f(d=>d.map(c=>c.id===s.id?{...c,id:l.id,status:"ok"}:c)),setTimeout(()=>{typeof window.refreshWhatsGoodComments=="function"?(console.log("Refreshing comment count for post:",r.id),window.refreshWhatsGoodComments(r.id)):console.warn("window.refreshWhatsGoodComments not available")},1e3)}catch{f(a=>a.map(l=>l.id===s.id?{...l,status:"error"}:l))}},q=async t=>{if(!(!t||t.status!=="error")){f(i=>i.map(s=>s.id===t.id?{...s,status:"pending"}:s));try{const{addDoc:i,serverTimestamp:s}=await D(async()=>{const{addDoc:a,serverTimestamp:l}=await import("./index-DYXKkgZj.js").then(d=>d.m);return{addDoc:a,serverTimestamp:l}},__vite__mapDeps([0,1])),n=await i(N(m,"community_comments"),{postId:r.id,communityId:r.communityId||"whats-good",brandId:r.brandId||null,userId:o.uid,userRole:o.role||"user",text:t.text,createdAt:s()});f(a=>a.map(l=>l.id===t.id?{...l,id:n.id,status:"ok"}:l))}catch{f(s=>s.map(n=>n.id===t.id?{...n,status:"error"}:n))}}};if(T)return e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-6",children:[e.jsx("div",{className:"animate-pulse h-5 w-24 bg-gray-200 rounded"}),e.jsxs("div",{className:"mt-4 bg-white rounded-lg border border-gray-200 p-4",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-3/4 mb-3"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-full mb-2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-5/6"})]})]});if(!r)return e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-6 space-y-4",children:[e.jsx("button",{onClick:()=>C("/staff/community"),className:"text-sm text-gray-600 hover:text-gray-800",children:"â† Back to community"}),e.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6 text-center text-gray-600",children:"Post not found."})]});const B=r.timeAgo||"";return e.jsxs("div",{className:"min-h-screen bg-cool-gray",children:[e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-4",children:[e.jsx("button",{onClick:()=>C(-1),className:"text-sm text-gray-600 hover:text-gray-800","aria-label":"Go back",children:"â† Back"}),e.jsxs("article",{className:"mt-4 bg-white rounded-lg border border-gray-200 p-4",children:[e.jsxs("header",{className:"flex items-start justify-between gap-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"inline-flex items-center px-3 h-7 min-h-[28px] rounded-full text-xs font-medium border border-deep-moss/30 text-deep-moss bg-white",children:r.brand||"General"})}),B&&e.jsx("time",{className:"text-xs text-warm-gray",children:B})]}),e.jsx("h1",{ref:S,tabIndex:-1,className:"mt-3 text-xl font-semibold text-gray-900",children:r.title||"Update"}),r.content&&e.jsx("div",{className:"mt-2 text-gray-800 whitespace-pre-wrap",children:r.content}),r.trainingId&&e.jsxs("section",{className:"mt-6 border-t border-gray-100 pt-4",children:[e.jsx("h2",{className:"text-sm font-medium text-gray-900",children:"Related training"}),e.jsx("button",{type:"button",onClick:()=>{Z({postId:r.id,trainingId:r.trainingId}),C(`/staff/trainings/${r.trainingId}`)},className:"mt-2 inline-flex items-center justify-center px-3 h-11 min-h-[44px] rounded-md border border-deep-moss text-sm text-deep-moss hover:bg-oat-beige","aria-label":"View related training",children:k.buttons.viewTraining})]}),e.jsxs("footer",{className:"mt-6 flex items-center gap-3",children:[e.jsxs("button",{type:"button",onClick:F,className:`inline-flex items-center justify-center px-3 h-11 min-h-[44px] rounded-md border text-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1 ${j?"border-rose-500 text-rose-600 bg-rose-50":"border-gray-300 text-gray-700 hover:bg-gray-50"}`,"aria-pressed":j?"true":"false","aria-label":j?`Unlike post (${P.length} likes)`:`Like post (${P.length} likes)`,"data-testid":"like-button",children:[e.jsx("span",{className:"mr-1","aria-hidden":!0,children:j?"â¤ï¸":"ðŸ¤"}),e.jsx("span",{children:k.buttons.like}),e.jsx("span",{className:"ml-2 text-gray-500",children:P.length})]}),U&&e.jsx("span",{className:"text-xs text-red-600",children:U}),e.jsxs("a",{href:"#comment",className:"inline-flex items-center justify-center px-3 h-11 min-h-[44px] rounded-md border border-gray-300 text-sm text-gray-700 hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1","aria-label":`Jump to comments (${I.length} comments)`,children:[e.jsx("span",{className:"mr-1","aria-hidden":!0,children:"ðŸ’¬"}),e.jsx("span",{children:k.buttons.comment}),e.jsx("span",{className:"ml-2 text-gray-500",children:I.length})]})]})]}),e.jsxs("section",{id:"comments",className:"mt-4",children:[e.jsx("h2",{className:"sr-only",children:"Comments"}),I.length===0?e.jsx("div",{className:"text-sm text-warm-gray",children:"No comments yet."}):e.jsx("ul",{className:"space-y-3",children:I.map(t=>{var i;return e.jsxs("li",{className:"bg-white rounded-lg border border-gray-200 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[e.jsx("span",{children:t.userRole||"user"}),e.jsx("span",{children:typeof((i=t.createdAt)==null?void 0:i.toDate)=="function"?t.createdAt.toDate().toLocaleString():t.createdAt instanceof Date?t.createdAt.toLocaleString():"Recently"})]}),e.jsx("p",{className:"mt-1 text-sm text-gray-800",children:t.text}),t.status==="error"&&e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs text-red-600",children:[e.jsx("span",{children:k.errors.generic}),e.jsx("button",{type:"button",onClick:()=>q(t),className:"mt-2 inline-flex items-center justify-center px-3 h-11 min-h-[44px] rounded-md border border-deep-moss text-sm text-deep-moss hover:bg-oat-beige focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-1",children:"Retry"})]}),t.status==="pending"&&e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Sendingâ€¦"})]},t.id)})})]})]}),e.jsx("div",{className:"sticky bottom-0 inset-x-0 border-t border-gray-200 bg-white",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-3 flex items-center gap-2",children:[e.jsx("input",{id:"comment",type:"text",value:L,onChange:t=>G(t.target.value),placeholder:"Add a commentâ€¦","aria-label":"Add a comment",className:"flex-1 px-3 py-3 h-11 min-h-[44px] border border-gray-300 rounded-md text-sm","data-testid":"comment-input"}),e.jsx("button",{type:"button",onClick:Q,className:"px-3 h-11 min-h-[44px] rounded-md bg-deep-moss text-white text-sm hover:bg-sage-dark disabled:opacity-50",disabled:!L.trim(),"data-testid":"comment-submit",children:"Post"})]})})]})}export{le as default};
//# sourceMappingURL=PostDetail-CluOUWl6.js.map
